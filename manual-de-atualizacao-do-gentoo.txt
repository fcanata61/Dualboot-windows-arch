###############################################################################
# Guia de Atualização do Gentoo - Seguro e Eficiente
# Autor: Gerado por ChatGPT
# Objetivo: Atualizar o Gentoo passo a passo, incluindo Python e pacotes críticos
###############################################################################

#############################
# 1. Sincronizar a árvore do Portage
#############################
# Atualiza a árvore de ebuilds para garantir que você está usando a versão mais recente
sudo emerge --sync

# Opcional: usar verbose para ver detalhes
# sudo emerge --sync --verbose

#############################
# 2. Ler o arquivo NEWS do Gentoo
#############################
# Sempre importante ler antes de atualizar pacotes críticos
less /usr/portage/News/*

# Aqui você encontra instruções sobre mudanças que podem quebrar pacotes
# Ex.: glibc, GCC, Python, systemd, OpenSSL

#############################
# 3. Atualizar pacotes críticos primeiro
#############################
# Atualize GCC e glibc antes de atualizar o sistema inteiro
sudo emerge --oneshot sys-devel/gcc
sudo emerge --oneshot sys-libs/glibc

# Para outros pacotes críticos (Python, OpenSSL, etc.)
sudo emerge --oneshot dev-lang/python
sudo emerge --oneshot dev-libs/openssl

#############################
# 4. Atualizar o resto do sistema
#############################
# Atualiza todos os pacotes do @world considerando mudanças de USE flags e dependências
sudo emerge --ask --update --deep --newuse @world

# Opções explicadas:
# --ask        : pergunta antes de instalar
# --update     : atualiza pacotes desatualizados
# --deep       : considera dependências de dependências
# --newuse     : recompila pacotes se USE flags mudaram

#############################
# 5. Limpeza de pacotes órfãos
#############################
# Antes de remover, veja o que será depclean
sudo emerge --depclean --pretend

# Se estiver seguro, execute a limpeza
sudo emerge --depclean

#############################
# 6. Rebuild de pacotes preservados
#############################
# Pacotes recompilados automaticamente por glibc, GCC ou Python
sudo emerge --ask --verbose @preserved-rebuild

#############################
# 7. Atualizar pacotes problemáticos
#############################
# Python: muitas vezes precisa atualizar pacotes dependentes
# Verifica pacotes que precisam ser recompilados por Python
sudo emerge --update --deep --newuse @world --with-bdeps=y

# GCC: atualizar pacotes que dependem do compilador
sudo emerge --update --deep --newuse @world

#############################
# 8. Atualizar Kernel (opcional)
#############################
# Baixe e configure o kernel, de preferência enxuto
# Exemplo usando genkernel:
sudo genkernel --menuconfig all

# Instala o kernel manual:
sudo make -j$(nproc)
sudo make modules_install
sudo make install

# Atualize o bootloader (GRUB):
sudo grub-mkconfig -o /boot/grub/grub.cfg

#############################
# 9. Limpeza final e verificação
#############################
# Verifica se existem pacotes quebrados ou inconsistentes
sudo revdep-rebuild

# Atualiza a base de dados de dependências
sudo emerge --depclean

# Confere se o sistema está atualizado e consistente
sudo emerge --ask --update --deep --newuse @world --pretend

#############################
# 10. Dicas extras
#############################
# - Sempre usar --pretend antes de comandos que removem pacotes ou recompilam
# - Ler NEWS do Gentoo antes de atualizar pacotes críticos
# - Para atualizações do Python, sempre recompilar pacotes dependentes
# - Use FEATURES="ccache distcc" no make.conf para acelerar recompilações
# - Para desktops, mantenha USE flags enxutas para evitar recompilações desnecessárias
# - Se estiver inseguro, atualize pacotes em etapas (glibc/GCC → resto → depclean → preserved-rebuild)

###############################################################################
# Fim do Guia de Atualização do Gentoo
###############################################################################
